# 构建和部署规范

## 构建配置

### 1. ESBuild 配置
- 使用 ESBuild 进行快速构建
- 配置 TypeScript 编译
- 支持开发和生产模式

```javascript
// ✅ 正确 - esbuild.config.mjs
import esbuild from 'esbuild';
import process from 'process';

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === 'production');

esbuild.build({
  banner: {
    js: banner,
  },
  entryPoints: ['src/main.ts'],
  bundle: true,
  external: ['obsidian'],
  format: 'cjs',
  watch: !prod,
  target: 'es2018',
  logLevel: 'info',
  sourcemap: prod ? false : 'inline',
  treeShaking: true,
  outfile: 'main.js',
}).catch(() => process.exit(1));
```

### 2. TypeScript 配置
- 使用严格的 TypeScript 配置
- 配置模块解析
- 设置目标版本

```json
// ✅ 正确 - tsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "inlineSourceMap": true,
    "inlineSources": true,
    "module": "ESNext",
    "target": "ES6",
    "allowJs": true,
    "noImplicitAny": true,
    "moduleResolution": "node",
    "importHelpers": true,
    "isolatedModules": true,
    "strictNullChecks": true,
    "lib": [
      "DOM",
      "ES5",
      "ES6",
      "ES7"
    ]
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx"
  ]
}
```

### 3. 包管理配置
- 使用 Yarn 进行依赖管理
- 配置脚本命令
- 管理开发依赖

```json
// ✅ 正确 - package.json
{
  "name": "obsidian-zotero-desktop-connector",
  "version": "3.2.1",
  "description": "Zotero Integration for Obsidian",
  "main": "main.js",
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "node esbuild.config.mjs production",
    "check-types": "tsc --noEmit",
    "lint": "eslint ./src",
    "lint:fix": "eslint ./src/**/* --fix",
    "prettier": "prettier --write \"./src/**/*.{ts,tsx}\"",
    "clean": "yarn prettier && yarn lint:fix",
    "test": "jest",
    "bump": "node version-bump.mjs && git add manifest.json versions.json package.json && yarn rlnotes",
    "release": "git commit -m $npm_package_version && git tag $npm_package_version && git push && git push --tags"
  },
  "devDependencies": {
    "@types/node": "20.3.3",
    "@typescript-eslint/eslint-plugin": "5.61.0",
    "@typescript-eslint/parser": "5.61.0",
    "esbuild": "0.18.11",
    "eslint": "8.44.0",
    "prettier": "2.8.8",
    "typescript": "5.1.6"
  }
}
```

## 代码质量工具

### 1. ESLint 配置
- 使用 TypeScript ESLint 规则
- 配置代码风格检查
- 支持 React 组件检查

```javascript
// ✅ 正确 - .eslintrc.js
module.exports = {
  parser: '@typescript-eslint/parser',
  plugins: ['@typescript-eslint'],
  extends: [
    'eslint:recommended',
    '@typescript-eslint/recommended',
  ],
  rules: {
    '@typescript-eslint/no-unused-vars': 'error',
    '@typescript-eslint/explicit-function-return-type': 'warn',
    '@typescript-eslint/no-explicit-any': 'warn',
    'prefer-const': 'error',
    'no-var': 'error',
  },
  env: {
    browser: true,
    es2021: true,
    node: true,
  },
  parserOptions: {
    ecmaVersion: 12,
    sourceType: 'module',
  },
};
```

### 2. Prettier 配置
- 统一代码格式化规则
- 配置编辑器集成
- 支持 TypeScript 格式化

```javascript
// ✅ 正确 - prettier.config.cjs
module.exports = {
  semi: true,
  trailingComma: 'es5',
  singleQuote: true,
  printWidth: 100,
  tabWidth: 2,
  useTabs: false,
  bracketSpacing: true,
  arrowParens: 'avoid',
  endOfLine: 'lf',
  overrides: [
    {
      files: '*.ts',
      options: {
        parser: 'typescript',
      },
    },
    {
      files: '*.tsx',
      options: {
        parser: 'typescript',
        jsxSingleQuote: true,
      },
    },
  ],
};
```

### 3. 编辑器配置
- 配置编辑器设置
- 统一团队开发环境
- 支持自动格式化

```ini
# ✅ 正确 - .editorconfig
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
indent_style = space
indent_size = 2

[*.{ts,tsx,js,jsx}]
indent_size = 2

[*.md]
trim_trailing_whitespace = false
```

## 版本管理

### 1. 版本更新脚本
- 自动化版本号更新
- 同步多个配置文件
- 生成发布说明

```javascript
// ✅ 正确 - version-bump.mjs
import { readFileSync, writeFileSync } from 'fs';
import { execSync } from 'child_process';

function updateVersion() {
  // 读取当前版本
  const packageJson = JSON.parse(readFileSync('package.json', 'utf8'));
  const currentVersion = packageJson.version;
  
  // 更新版本号
  const [major, minor, patch] = currentVersion.split('.').map(Number);
  const newVersion = `${major}.${minor}.${patch + 1}`;
  
  // 更新 package.json
  packageJson.version = newVersion;
  writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
  
  // 更新 manifest.json
  const manifestJson = JSON.parse(readFileSync('manifest.json', 'utf8'));
  manifestJson.version = newVersion;
  writeFileSync('manifest.json', JSON.stringify(manifestJson, null, 2));
  
  // 更新 versions.json
  const versionsJson = JSON.parse(readFileSync('versions.json', 'utf8'));
  versionsJson[newVersion] = {
    minAppVersion: manifestJson.minAppVersion,
    downloadUrl: `https://github.com/mgmeyers/obsidian-zotero-integration/releases/download/${newVersion}/main.js`,
  };
  writeFileSync('versions.json', JSON.stringify(versionsJson, null, 2));
  
  console.log(`Version updated to ${newVersion}`);
}

updateVersion();
```

### 2. 发布说明生成
- 自动生成发布说明
- 基于 Git 提交历史
- 格式化发布信息

```javascript
// ✅ 正确 - 发布说明生成
function generateReleaseNotes() {
  const lastTag = execSync('git describe --tags --abbrev=0', { encoding: 'utf8' }).trim();
  const commits = execSync(`git log ${lastTag}..HEAD --oneline`, { encoding: 'utf8' });
  
  const releaseNotes = `# Release Notes

## Changes since ${lastTag}

${commits.split('\n').filter(Boolean).map(commit => `- ${commit}`).join('\n')}
`;
  
  writeFileSync('release-notes.md', releaseNotes);
}
```

## 部署流程

### 1. 构建流程
- 开发模式：热重载和快速构建
- 生产模式：优化和压缩
- 类型检查：确保类型安全

```bash
# ✅ 正确 - 构建命令
# 开发模式
npm run dev

# 生产构建
npm run build

# 类型检查
npm run check-types

# 代码质量检查
npm run lint
npm run prettier
```

### 2. 测试流程
- 单元测试配置
- 集成测试
- 自动化测试

```javascript
// ✅ 正确 - Jest 配置
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  transform: {
    '^.+\\.ts$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
};
```

### 3. 发布流程
- 自动化发布脚本
- 版本标签管理
- 发布到 GitHub Releases

```bash
# ✅ 正确 - 发布流程
# 1. 更新版本号
npm run bump

# 2. 构建生产版本
npm run build

# 3. 运行测试
npm test

# 4. 提交并发布
npm run release
```

## 依赖管理

### 1. 依赖分类
- 生产依赖：运行时必需的包
- 开发依赖：构建和开发工具
- 对等依赖：Obsidian API

```json
// ✅ 正确 - 依赖管理
{
  "dependencies": {
    "download": "8.0.0",
    "escape-path-with-spaces": "1.0.2",
    "execa": "7.1.1",
    "fuse.js": "6.6.2",
    "nunjucks": "3.2.4",
    "preact": "10.15.1",
    "react": "npm:@preact/compat",
    "react-dom": "npm:@preact/compat"
  },
  "devDependencies": {
    "@types/node": "20.3.3",
    "@typescript-eslint/eslint-plugin": "5.61.0",
    "esbuild": "0.18.11",
    "eslint": "8.44.0",
    "prettier": "2.8.8",
    "typescript": "5.1.6"
  },
  "peerDependencies": {
    "obsidian": ">=1.1.1"
  }
}
```

### 2. 版本锁定
- 使用 Yarn.lock 锁定版本
- 定期更新依赖
- 安全漏洞检查

```bash
# ✅ 正确 - 依赖管理命令
# 安装依赖
yarn install

# 更新依赖
yarn upgrade

# 检查安全漏洞
yarn audit

# 修复安全漏洞
yarn audit --fix
```

## 环境配置

### 1. 环境变量
- 开发环境配置
- 生产环境配置
- 敏感信息管理

```javascript
// ✅ 正确 - 环境配置
const isDevelopment = process.env.NODE_ENV === 'development';
const isProduction = process.env.NODE_ENV === 'production';

const config = {
  development: {
    debug: true,
    logLevel: 'debug',
    hotReload: true,
  },
  production: {
    debug: false,
    logLevel: 'error',
    hotReload: false,
  },
};

export const currentConfig = config[process.env.NODE_ENV] || config.development;
```

### 2. 路径配置
- 跨平台路径处理
- 相对路径和绝对路径
- 文件系统兼容性

```typescript
// ✅ 正确 - 路径处理
import path from 'path';
import { normalizePath } from 'obsidian';

export function getPluginPath(): string {
  return normalizePath(__dirname);
}

export function getTemplatePath(templateName: string): string {
  return normalizePath(path.join(getPluginPath(), 'templates', templateName));
}

export function sanitizeFilePath(filePath: string): string {
  return filePath
    .replace(/[<>:"/\\|?*]/g, '_')
    .replace(/\s+/g, '_')
    .replace(/__+/g, '_')
    .trim();
}
```

## 性能优化

### 1. 构建优化
- 代码分割和懒加载
- 树摇优化
- 压缩和混淆

```javascript
// ✅ 正确 - 构建优化配置
esbuild.build({
  entryPoints: ['src/main.ts'],
  bundle: true,
  minify: prod,
  sourcemap: !prod,
  treeShaking: true,
  target: 'es2018',
  format: 'cjs',
  external: ['obsidian'],
  define: {
    'process.env.NODE_ENV': prod ? '"production"' : '"development"',
  },
});
```

### 2. 运行时优化
- 异步加载
- 缓存策略
- 内存管理

```typescript
// ✅ 正确 - 运行时优化
export class CacheManager {
  private cache = new Map<string, any>();
  private maxSize = 100;
  
  get(key: string): any {
    return this.cache.get(key);
  }
  
  set(key: string, value: any): void {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }
  
  clear(): void {
    this.cache.clear();
  }
}
```
description:
globs:
alwaysApply: false
---
