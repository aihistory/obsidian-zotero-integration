# 封面集成调试指南

## 🔍 当前问题诊断

您遇到的问题是封面处理流程在"开始处理封面图片，文件数量: 1"之后停止了，没有继续执行。

## 🚨 可能的原因

### 1. 模块导入失败
- `./bbt/cayw` 或 `./bbt/jsonRPC` 模块导入可能失败
- 这些模块中的函数可能不存在或名称不匹配

### 2. 数据库连接问题
- Zotero 数据库连接可能有问题
- `getCiteKeys` 或 `getItemJSONFromCiteKeys` 调用失败

### 3. 异步操作异常
- 某个 await 操作可能抛出了未捕获的异常
- 导致整个流程静默失败

## 📋 增强的调试日志

我已经添加了更详细的调试日志，现在重新加载插件后，您应该看到以下信息：

### 预期的完整日志流程
```
开始导出，包含封面图片处理
封面图片功能已启用，开始处理封面
开始处理封面图片，文件数量: 1
数据库配置: {database: "Zotero", port: undefined}
显式引用键: [{key: "...", library: 1}]
正在导入必要的函数...
函数导入成功
正在获取引用键...
获取到引用键: [{key: "...", library: 1}]
库ID: 1
正在获取项目数据...
✅ 获取到项目数据，数量: 1
第一个项目数据样本: {title: "...", citekey: "...", itemType: "...", attachments: 0}
开始逐个处理项目封面...
处理项目封面: ...
附件文件夹: assets/...
[封面处理日志]
✅ 封面图片处理完成
```

### 如果在某个步骤失败，会看到错误信息
```
❌ 导入函数或获取数据时出错: [错误详情]
错误堆栈: [堆栈信息]
```

## 🔧 故障排除步骤

### 步骤 1: 重新加载插件
1. 重新编译并加载插件
2. 尝试再次导入 Zotero 项目
3. 观察控制台输出

### 步骤 2: 检查具体停止位置
根据日志输出，确定具体在哪个步骤停止：

**如果停在 "正在导入必要的函数..."**
- 模块导入失败
- 可能是路径或导出名称问题

**如果停在 "正在获取引用键..."**
- `getCiteKeys` 函数调用失败
- 可能是数据库连接问题

**如果停在 "正在获取项目数据..."**
- `getItemJSONFromCiteKeys` 函数调用失败
- 可能是 Zotero API 问题

**如果停在 "开始逐个处理项目封面..."**
- 项目数据获取成功，但封面处理失败
- 可能是封面 URL 提取或下载问题

### 步骤 3: 验证基础功能
如果集成的封面处理有问题，可以先验证基础功能：

1. 使用测试命令 "Test cover image download"
2. 检查是否能正常下载测试封面
3. 确认基础功能正常后再排查集成问题

## 🛠️ 临时解决方案

如果集成功能持续有问题，可以考虑以下方案：

### 方案 1: 简化集成
暂时禁用自动封面处理，只保留手动测试功能

### 方案 2: 延迟处理
将封面处理移到导入完成后的后台任务中

### 方案 3: 条件启用
添加一个开关来控制是否启用集成的封面处理

## 📝 下一步行动

1. **立即**: 重新加载插件并查看详细日志
2. **根据日志**: 确定具体的失败点
3. **报告结果**: 将完整的控制台日志发送给我进行进一步分析

## 🔍 需要的信息

请提供以下信息以便进一步诊断：

1. **完整的控制台日志** (从"开始导出"到最后一条消息)
2. **Zotero 连接状态** (是否能正常使用其他 Zotero Integration 功能)
3. **导入的项目类型** (书籍、文章、网页等)
4. **插件设置** (封面相关设置是否正确启用)

---

**调试版本**: v1.1.0  
**更新日期**: 2024-08-17  
**状态**: 等待用户反馈详细日志
